.. _heapster:

==========================
Kubernetes Heapster   搭建
==========================

.. note::

   1. 以下所以shell命令都是在root用户下执行
   2. Kubernetes集群环境已搭建好，请参考 :ref:`kubernetes-cluster-environment`

.. end

Prerequisites
~~~~~~~~~~~~~



Deploy
~~~~~~

#. 准备heapster.yaml文件:

   .. code-block:: yaml

      apiVersion: v1
      kind: ReplicationController
      metadata:
        labels:
          kubernetes.io/cluster-service: 'true'
          k8s-app: heapster
          name: heapster
        name: heapster
        namespace: kube-system
      spec:
        replicas: 1
        selector:
          kubernetes.io/cluster-service: "true"
          k8s-app: heapster
        template:
          metadata:
            labels:
              kubernetes.io/cluster-service: 'true'
              k8s-app: heapster
          spec:
            containers:
            - name: heapster
              image: heapster:v1.3.0
              imagePullPolicy: IfNotPresent
              command:
              - /heapster
              - --source=kubernetes:http://192.168.111.14:8080?inClusterConfig=false
              - --sink=influxdb:http://monitoring-influxdb:8086
              - --metric_resolution=60s
              volumeMounts:
              - name: ssl-certs
                mountPath: /etc/ssl/certs
                readOnly: true
            volumes:
            - name: ssl-certs
              hostPath:
                path: /etc/ssl/certs

   .. end


#. 准备heapster-svc.yaml文件:

   .. code-block:: yaml

      apiVersion: v1
      kind: Service
      metadata:
        labels:
          kubernetes.io/cluster-service: 'true'
          kubernetes.io/name: heapster
        name: heapster
        namespace: kube-system
      spec:
        type: NodePort
        ports:
        - port: 80
          nodePort: 30005
          targetPort: 8082
        selector:
          kubernetes.io/cluster-service: "true"
          k8s-app: heapster

   .. end


#. 准备infludb.yaml文件:

   .. code-block:: yaml

      apiVersion: v1
      kind: ReplicationController
      metadata:
        labels:
          kubernetes.io/cluster-service: 'true'
          name: influxGrafana
        name: influxdb-grafana
        namespace: kube-system
      spec:
        replicas: 1
        selector:
          kubernetes.io/cluster-service: "true"
          name: influxGrafana
        template:
          metadata:
            labels:
              kubernetes.io/cluster-service: 'true'
              name: influxGrafana
          spec:
            containers:
            - name: influxdb
              image: heapster_influxdb:v0.6
              imagePullPolicy: IfNotPresent
              volumeMounts:
              - mountPath: /data
                name: influxdb-storage
              volumeMounts:
              - mountPath: /var
                name: grafana-storage
            volumes:
            - name: influxdb-storage
              emptyDir: {}
            - name: grafana-storage
              emptyDir: {}

   .. end


#. 准备infludb-svc.yaml文件:

   .. code-block:: yaml

      apiVersion: v1
      kind: Service
      metadata:
        labels:
          kubernetes.io/cluster-service: 'true'
          kubernetes.io/name: monitoring-influxdb
        name: monitoring-influxdb
        namespace: kube-system
      spec:
        ports:
        - name: http
          port: 8083
          targetPort: 8083
        - name: api
          port: 8086
          targetPort: 8086
        selector:
          kubernetes.io/cluster-service: "true"
          name: influxGrafana

   .. end


#. create objects with yamls

   .. code-block:: console

      [root@master ~]# kubectl create -f heapster.yaml
      [root@master ~]# kubectl create -f heapster-svc.yaml
      [root@master ~]# kubectl create -f infludb.yaml
      [root@master ~]# kubectl create -f infludb-svc.yaml

   .. end


Verify
~~~~~~

#. visit `http://master:8080/ui <http://master:8080/ui>`__:


