<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Kubernetes DNS 搭建 &mdash; k8s 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="k8s 1.0 documentation" href="../index.html" />
    <link rel="up" title="Kubernets Notes" href="index.html" />
    <link rel="next" title="Kubernetes dashboard 搭建" href="kubernetes-dashboard.html" />
    <link rel="prev" title="Kubernetes 集群环境搭建" href="environment.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="kubernetes-dashboard.html" title="Kubernetes dashboard 搭建"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="environment.html" title="Kubernetes 集群环境搭建"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">k8s 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Kubernets Notes</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="kubernetes-dns">
<span id="id1"></span><h1>Kubernetes DNS 搭建<a class="headerlink" href="#kubernetes-dns" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ol class="last arabic simple">
<li>以下所以shell命令都是在root用户下执行</li>
<li>Kubernetes集群环境已搭建好，请参考 <a class="reference internal" href="environment.html#kubernetes-cluster-environment"><em>Kubernetes 集群环境搭建</em></a></li>
</ol>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="71%" />
<col width="29%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>docker镜像</td>
<td>version</td>
</tr>
<tr class="row-even"><td>gcr.io/google_containers/k8s-dns-kube-dns-amd64</td>
<td><tt class="docutils literal"><span class="pre">1.14.4</span></tt></td>
</tr>
<tr class="row-odd"><td>gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64</td>
<td><tt class="docutils literal"><span class="pre">1.14.4</span></tt></td>
</tr>
<tr class="row-even"><td>gcr.io/google_containers/k8s-dns-sidecar-amd64</td>
<td><tt class="docutils literal"><span class="pre">1.14.4</span></tt></td>
</tr>
<tr class="row-odd"><td>radial/busyboxplus</td>
<td><tt class="docutils literal"><span class="pre">curl</span></tt></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="deploy">
<h2>Deploy<a class="headerlink" href="#deploy" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">准备kubedns-controller.yaml:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">k8s-app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
    <span class="l l-Scalar l-Scalar-Plain">kubernetes.io/cluster-service</span><span class="p p-Indicator">:</span> <span class="s">&quot;true&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">addonmanager.kubernetes.io/mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Reconcile</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="c1"># replicas: not specified here:</span>
  <span class="c1"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span>
  <span class="c1"># 2. Default is 1.</span>
  <span class="c1"># 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span>
  <span class="l l-Scalar l-Scalar-Plain">strategy</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">rollingUpdate</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">maxSurge</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10%</span>
      <span class="l l-Scalar l-Scalar-Plain">maxUnavailable</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">matchLabels</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">k8s-app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">k8s-app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
      <span class="l l-Scalar l-Scalar-Plain">annotations</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">scheduler.alpha.kubernetes.io/critical-pod</span><span class="p p-Indicator">:</span> <span class="s">&#39;&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kubedns</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.4</span>
        <span class="l l-Scalar l-Scalar-Plain">resources</span><span class="p p-Indicator">:</span>
          <span class="c1"># TODO: Set memory limits when we&#39;ve profiled the container for large</span>
          <span class="c1"># clusters, then set request = limit to keep this container in</span>
          <span class="c1"># guaranteed class. Currently, this container falls into the</span>
          <span class="c1"># &quot;burstable&quot; category so the kubelet doesn&#39;t backoff from restarting it.</span>
          <span class="l l-Scalar l-Scalar-Plain">limits</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">memory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">170Mi</span>
          <span class="l l-Scalar l-Scalar-Plain">requests</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">cpu</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">100m</span>
            <span class="l l-Scalar l-Scalar-Plain">memory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">70Mi</span>
        <span class="l l-Scalar l-Scalar-Plain">livenessProbe</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">httpGet</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/healthcheck/kubedns</span>
            <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10054</span>
            <span class="l l-Scalar l-Scalar-Plain">scheme</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>
          <span class="l l-Scalar l-Scalar-Plain">initialDelaySeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
          <span class="l l-Scalar l-Scalar-Plain">timeoutSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="l l-Scalar l-Scalar-Plain">successThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="l l-Scalar l-Scalar-Plain">failureThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="l l-Scalar l-Scalar-Plain">readinessProbe</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">httpGet</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/readiness</span>
            <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8081</span>
            <span class="l l-Scalar l-Scalar-Plain">scheme</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>
          <span class="c1"># we poll on pod startup for the Kubernetes master service and</span>
          <span class="c1"># only setup the /readiness HTTP server once that&#39;s available.</span>
          <span class="l l-Scalar l-Scalar-Plain">initialDelaySeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
          <span class="l l-Scalar l-Scalar-Plain">timeoutSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="l l-Scalar l-Scalar-Plain">args</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--domain=cluster.local.</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--dns-port=10053</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--kube-master-url=http://10.20.0.100:8080</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--v=2</span>
        <span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PROMETHEUS_PORT</span>
          <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;10055&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10053</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dns-local</span>
          <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">UDP</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10053</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dns-tcp-local</span>
          <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10055</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">metrics</span>
          <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dnsmasq</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.4</span>
        <span class="l l-Scalar l-Scalar-Plain">livenessProbe</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">httpGet</span><span class="p p-Indicator">:</span>
<span class="hll">            <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/healthcheck/dnsmasq</span>
</span>            <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10054</span>
            <span class="l l-Scalar l-Scalar-Plain">scheme</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>
          <span class="l l-Scalar l-Scalar-Plain">initialDelaySeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
          <span class="l l-Scalar l-Scalar-Plain">timeoutSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="l l-Scalar l-Scalar-Plain">successThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="l l-Scalar l-Scalar-Plain">failureThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="l l-Scalar l-Scalar-Plain">args</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">-v=2</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">-logtostderr</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">-restartDnsmasq=true</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">-k</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--cache-size=1000</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--log-facility=-</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--server=/cluster.local/127.0.0.1#10053</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--server=/in-addr.arpa/127.0.0.1#10053</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--server=/ip6.arpa/127.0.0.1#10053</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">53</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dns</span>
          <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">UDP</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">53</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dns-tcp</span>
          <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="c1"># see: https://github.com/kubernetes/kubernetes/issues/29055 for details</span>
        <span class="l l-Scalar l-Scalar-Plain">resources</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">requests</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">cpu</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">150m</span>
            <span class="l l-Scalar l-Scalar-Plain">memory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20Mi</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sidecar</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.4</span>
        <span class="l l-Scalar l-Scalar-Plain">livenessProbe</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">httpGet</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/metrics</span>
            <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10054</span>
            <span class="l l-Scalar l-Scalar-Plain">scheme</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>
          <span class="l l-Scalar l-Scalar-Plain">initialDelaySeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
          <span class="l l-Scalar l-Scalar-Plain">timeoutSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="l l-Scalar l-Scalar-Plain">successThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="l l-Scalar l-Scalar-Plain">failureThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="l l-Scalar l-Scalar-Plain">args</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--v=2</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--logtostderr</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.cluster.local,5,A</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.cluster.local,5,A</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10054</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">metrics</span>
          <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="l l-Scalar l-Scalar-Plain">resources</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">requests</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">memory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20Mi</span>
            <span class="l l-Scalar l-Scalar-Plain">cpu</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
      <span class="l l-Scalar l-Scalar-Plain">dnsPolicy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Default</span>  <span class="c1"># Don&#39;t use cluster DNS.</span>
</pre></div>
</td></tr></table></div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>You need to replace <tt class="docutils literal"><span class="pre">-</span> <span class="pre">--kube-master-url=http://master:8080</span></tt> at line 82</p>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p><tt class="docutils literal"><span class="pre">master</span></tt> is the host ip of master node</p>
<p class="last"><tt class="docutils literal"><span class="pre">8080</span></tt> is the port which kube-apiserver is listening to</p>
</div>
</div>
</li>
<li><p class="first">准备kubedns-svc.yaml</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">k8s-app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
    <span class="l l-Scalar l-Scalar-Plain">kubernetes.io/cluster-service</span><span class="p p-Indicator">:</span> <span class="s">&quot;true&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">addonmanager.kubernetes.io/mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Reconcile</span>
    <span class="l l-Scalar l-Scalar-Plain">kubernetes.io/name</span><span class="p p-Indicator">:</span> <span class="s">&quot;KubeDNS&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">k8s-app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-dns</span>
  <span class="l l-Scalar l-Scalar-Plain">clusterIP</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10.254.1.1</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dns</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">53</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">UDP</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dns-tcp</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">53</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
</pre></div>
</td></tr></table></div>
<p>可自定义修改kubedns-svc.yaml中30行的clusterIP为/etc/kubernetes/apiserver中定义的
KUBE_SERVICE_ADDRESSES=&#8221;&#8211;service-cluster-ip-range=10.254.0.0/16&#8221;的网络中的一个。</p>
</li>
<li><p class="first">create pod from kubedns-controller.yaml and kubedns-svc.yaml</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">[root@master ~]#</span> kubectl create -f kubedns-controller.yaml
<span class="gp">[root@master ~]#</span> kubectl create -f kubedns-svc.yaml
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="verify">
<h2>Verify<a class="headerlink" href="#verify" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">create pod from busybox.yaml:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">busybox</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">busybox</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">radial/busyboxplus:curl</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sleep</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;3600&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">imagePullPolicy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">[root@master ~]#</span> kubectl create -f busybox.yaml
</pre></div>
</div>
</li>
<li><p class="first">在容器成功启动后，通过kubectl exec &lt;container_id&gt; nslookup 进行测试：</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">[root@master ~]#</span> kubectl <span class="nb">exec</span> busybox -- nslookup kubernetes-dashboard.kube-system
<span class="go">Server:    10.254.1.1</span>
<span class="go">Address 1: 10.254.1.1 kube-dns.kube-system.svc.cluster.local</span>

<span class="go">Name:      kubernetes-dashboard.kube-system</span>
<span class="go">Address 1: 10.254.193.179 kubernetes-dashboard.kube-system.svc.cluster.local</span>
</pre></div>
</div>
<p>出现以上的DNS信息则表面kubernetes dns服务成功部署。</p>
</li>
</ol>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Kubernetes DNS 搭建</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#deploy">Deploy</a></li>
<li><a class="reference internal" href="#verify">Verify</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="environment.html"
                        title="previous chapter">Kubernetes 集群环境搭建</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="kubernetes-dashboard.html"
                        title="next chapter">Kubernetes dashboard 搭建</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/k8s/kubernetes-dns.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="kubernetes-dashboard.html" title="Kubernetes dashboard 搭建"
             >next</a> |</li>
        <li class="right" >
          <a href="environment.html" title="Kubernetes 集群环境搭建"
             >previous</a> |</li>
        <li><a href="../index.html">k8s 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Kubernets Notes</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2017, zhengchuan.hu@easystack.cn.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>